// Prisma schema for STT MCP

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Conversations
model Conversation {
  id           String    @id @default(uuid())
  name         String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  messageCount Int       @default(0)

  // Relations
  messages     Message[]
  apiKeys      ApiKey?
  voiceConfig  VoiceConfig?

  @@index([createdAt])
}

// Messages in conversations
model Message {
  id             String   @id @default(uuid())
  conversationId String
  role           String   // "user" | "assistant"
  content        String
  audioUrl       String?
  ssmlUsed       String?
  timestamp      DateTime @default(now())

  // Metrics (stored as JSON)
  metrics        String?  // JSON string of metrics object

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, timestamp])
}

// API Keys per conversation
model ApiKey {
  id             String   @id @default(uuid())
  conversationId String   @unique
  openai         String?
  elevenlabs     String?
  gemini         String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

// Voice configuration per conversation
model VoiceConfig {
  id             String   @id @default(uuid())
  conversationId String   @unique

  // TTS Settings
  voiceId        String?
  model          String   @default("eleven_flash_v2")

  // SSML Settings
  ssmlEnabled    Boolean  @default(true)
  ssmlModel      String   @default("gpt-4o-mini")
  prosodyEnabled Boolean  @default(true)
  emphasisEnabled Boolean @default(true)
  phonemesEnabled Boolean @default(false)
  formality      String   @default("neutral") // "casual" | "neutral" | "formal"
  maxBreaksPer100Words Int @default(3)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
}

// Global Settings (single row)
model Settings {
  id                      Int      @id @default(1)

  // Audio Capture
  inputDeviceId           String?
  sampleRate              Int      @default(48000)
  noiseSuppressionEnabled Boolean  @default(true)

  // VAD & Chunking
  vadThreshold            Float    @default(0.5)
  minSilenceMs            Int      @default(500)
  maxUtteranceMs          Int      @default(15000)
  minSpeechMs             Int      @default(200)
  trimLongSilences        Boolean  @default(true)
  maxChunkLengthMs        Int      @default(20000)

  // STT
  sttProvider             String   @default("gemini")
  sttModel                String   @default("gemini-1.5-flash")
  sttLocale               String   @default("en-US")
  sttEncoding             String   @default("webm")
  sendPartials            Boolean  @default(false)

  // TTS (defaults)
  ttsProvider             String   @default("elevenlabs")
  ttsVoiceId              String?  // Default voice
  ttsModel                String   @default("eleven_flash_v2")
  ttsStreamPlayback       Boolean  @default(true)
  ttsAutoplay             Boolean  @default(true)

  // SSML Enhancer (defaults)
  ssmlEnabled             Boolean  @default(true)
  ssmlModel               String   @default("gpt-4o-mini")
  ssmlEnableProsody       Boolean  @default(true)
  ssmlEnableEmphasis      Boolean  @default(true)
  ssmlEnablePhonemes      Boolean  @default(false)
  ssmlFormality           String   @default("neutral")
  ssmlMaxBreaksPer100Words Int     @default(3)

  // Interaction
  defaultMode             String   @default("manual")
  autoSendInAutoMode      Boolean  @default(true)
  pttKeybinding           String   @default("Space")

  // Privacy & Storage
  keepConversationHistory Boolean  @default(true)
  retentionDays           Int      @default(30)

  // Advanced
  loggingLevel            String   @default("info")
  metricsEnabled          Boolean  @default(true)
  backendUrl              String   @default("http://localhost:3000")

  updatedAt               DateTime @updatedAt
}
